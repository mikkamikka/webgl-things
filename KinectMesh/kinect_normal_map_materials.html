
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Kinect mesh test</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <style>
    body {
      color: #ffffff;
      font-family:Monospace;
      font-size:13px;
      text-align:center;
      font-weight: normal;

      background-color: #000000;
      margin: 0px;
      overflow: hidden;
    }
    #info {
      position: absolute;
      bottom: 0px; width: 100%;
      padding: 5px;
    }
    #gui_container {
      right: 0;
      position: absolute;
      top: 0;
      z-index:100;
    }
    #gui {
    //right: 0;
    //position: absolute;
    //top: 0;
    //z-index:100;
    }
    #checkboxes {
      right: 0;
      position: absolute;
      top: 50%;
      width: 220px;
      z-index:100;
    }
    #video_buttons {
      position: absolute;
      top: 50%; transform: translateY(-50%);
      left: 0px;
      width: 170px;
      z-index: 100;
    }
    video {
      width: 100%;
      display:block;
      padding: 4px;
    }
    a {
      color:#eeeeee;
    }
    a:hover {
      color:#0e44ff;
    }
  </style>
</head>
<body>

<div id="info">
  Kinect depth height map + physical material test <br/>
  Created by <a href="http://twitter.com/blackmika" target="_blank">@blackmika</a>.
</div>

<div id="container"></div>


<div id="video_buttons">
  <div style="font-weight: normal">Click to play/pause</div>
  <div id="buttons">
    <video autoplay accessKey="0" >
      <source src="media/zora.ogg" type='video/ogg; codecs="theora, vorbis"'>
    </video>
    <!--video accessKey="2">
      <source src="../image/waves1.ogg" type='video/ogg; codecs="theora, vorbis"'>
    </video>
    <video accessKey="3">
      <source src="../image/waves5.ogg" type='video/ogg; codecs="theora, vorbis"'>
    </video>
    <video accessKey="4">
      <source src="../image/waves6.ogg" type='video/ogg; codecs="theora, vorbis"'>
    </video-->
  </div>
</div>

<div id="gui_container">
  <div id="gui"></div>
</div>

<script id="vertexShader" type="x-shader/x-vertex">
    uniform vec2 resolution;

    uniform sampler2D displacementMap;
    uniform float displacementScale;
    uniform float displacementBias;

    //uniform float normalsRatio;
    uniform float lookupRadius;
    uniform float mode;
    varying float drawMode;

    void main() {

      vec3 transformed = position;

      float mean = ( texture2D( displacementMap, uv ).x + texture2D( displacementMap, uv ).y + texture2D( displacementMap, uv ).z ) / 3.0;

      if ( texture2D( displacementMap, uv ).x == 0.0 ) drawMode = 0.0;
      else drawMode = 1.0;

      transformed += normal * ( mean * displacementScale + displacementBias );

      float aspect = resolution.x/resolution.y;
      float dx = lookupRadius / resolution.x;
      float dy = dx * aspect;

      vec4 dy1 = texture2D( displacementMap, uv + vec2( 0.0, dy ) );
      vec4 dy2 = texture2D( displacementMap, uv + vec2( 0.0, -dy ) );

      vec4 dx1 = texture2D( displacementMap, uv + vec2( dx, 0.0 ) );
      vec4 dx2 = texture2D( displacementMap, uv + vec2( -dx, 0.0 ) );

      float difX = 0.0;
      float difY = 0.0;

      if (mode > 0.5){

        vec4 d5 = texture2D( displacementMap, uv + vec2( dx, dy ) );
        vec4 d6 = texture2D( displacementMap, uv + vec2( -dx, -dy ) );
        vec4 d7 = texture2D( displacementMap, uv + vec2( dx, -dy ) );
        vec4 d8 = texture2D( displacementMap, uv + vec2( -dx, dy ) );

        difX = ( dx1.x - dx2.x + d5.x - d6.x + d7.x - d8.x ) / 3.0;
        difY = ( dy1.y - dy2.y + d5.y - d6.y + d7.y - d8.y ) / 3.0;
      }
      else{

        difX = dx1.x - dx2.x;
        difY = dy1.y - dy2.y;

      }

      if (dx1.x == 0.0 || dx2.x==0.0 || dy1.x==0.0 || dy2.x==0.0) drawMode = 0.0;


      gl_Position = projectionMatrix * modelViewMatrix * vec4( transformed, 1.0 );

    }

    </script>

<script id="fragmentShader_wireframe" type="x-shader/x-fragment">

    varying float drawMode;
    uniform float opacity;

    void main() {

      gl_FragColor = vec4( 1.0, 1.0, 1.0, opacity );

      if (drawMode == 0.0) discard;

    }

    </script>

<script src="../r82/three.js"></script>
<script src="../libs/Detector.js"></script>
<script src="../libs/stats.min.js"></script>
<script src="../libs/dat.gui.min.js"></script>
<script src="../libs/controls/OrbitControls.js"></script>
<!--script src="../three.js-master-r82/examples/js/modifiers/BufferSubdivisionModifier.js"></script>
<script src="../three.js-master-r82/examples/js/modifiers/SimplifyModifier.js"></script>
<script src="../three.js-master-r82/examples/js/modifiers/ExplodeModifier.js"></script-->
<!--script src="geometry/PlaneBufferGeometryMika.js"></script-->
<script src="geometry/PlaneBufferGeometryRnd.js"></script>
<script src="material/materials.js"></script>


<script>

  if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

  var container, stats;

  var camera, scene, renderer, controls;
  var object, material, material2;
  var video = [], video_texture, textureSphere;
  var lights = [];
  var wireframeMaterial, multiMaterial;

  var depthWidth = 512, depthHeight = 424;

  var params = {
    lookupRadius: 4.0,
    displacementScale: 300.0,
    subdivision: 4,
    vertexXYRandomness: 0.50,
    vertexZRandomness: 0.50,

    color: new THREE.Color(0x000),
    roughness: 0.30,
    metalness: 0.30,
    opacity: 1.00,
    lightIntensity: 0.50,
    refraction: false,
    refractionRatio: 0.90,

    showWireframe: true,
    displacementScaleWireframe: 302.0,
    opacityWireframe: 0.1

  }

  var sortedGeometry, smooth;

  init();
  animate();

  var gui = new dat.GUI();

  var folderGeometry = gui.addFolder('Geometry');
  folderGeometry.open();

  folderGeometry.add(params, 'displacementScale').min(1).max(600).step(1).onChange(
          function(value){
            materialTest1.uniforms[ 'displacementScale' ].value = value;
          } );
  folderGeometry.add(params, 'subdivision').min(1).max(10).step(1).onChange(
          function(value){
            setMeshSubdivision( object, value );
          } );
  folderGeometry.add(params, 'vertexXYRandomness').min(0.0).max(1.0).step(0.01).onChange(
          function(value){
            setVertexRandomness( object );
          } );
  folderGeometry.add(params, 'vertexZRandomness').min(0.0).max(1.0).step(0.01).onChange(
          function(value){
            setVertexRandomness( object );
          } );

  var folderMaterial = gui.addFolder('Material');
  folderMaterial.open();

  folderMaterial.addColor(params, 'color').onChange(
          function(value){
            materialTest1.uniforms[ 'diffuse' ].value.r = value.r / 256;
            materialTest1.uniforms[ 'diffuse' ].value.g = value.g / 256;
            materialTest1.uniforms[ 'diffuse' ].value.b = value.b / 256;
          } );
  folderMaterial.add(params, 'roughness').min(0.0).max(1.0).step(0.01).onChange(
          function(value){
            materialTest1.uniforms[ 'roughness' ].value = value;
          } );
  folderMaterial.add(params, 'metalness').min(0.0).max(1.0).step(0.01).onChange(
          function(value){
            materialTest1.uniforms[ 'metalness' ].value = value;
          } );
  folderMaterial.add(params, 'opacity').min(0.0).max(1.0).step(0.01).onChange(
          function(value){
            materialTest1.uniforms[ 'opacity' ].value = value;
          } );

  folderMaterial.add(params, 'refraction').onChange(
          function(value){
            toggleRefraction( value );
          } );
  folderMaterial.add(params, 'refractionRatio').min(0.0).max(1.0).step(0.01).onChange(
          function(value){
            materialTest1.uniforms[ 'refractionRatio' ].value = value;
          } );

  folderMaterial.add(params, 'lightIntensity').min(0.0).max(1.0).step(0.01).onChange(
          function(value){
            for ( var i = 0; i < lights.length; i++ ){
              lights[ i ].intensity = value;
            }
          } );

  var folderMaterialWireframe = gui.addFolder('Wireframe');
  folderMaterialWireframe.open();

  folderMaterialWireframe.add(params, 'showWireframe').onChange(
          function(value){
            toggleWireframe( value );
          } );
  folderMaterialWireframe.add(params, 'displacementScaleWireframe').min(1).max(600).step(1).onChange(
          function(value){
            wireframeMaterial.uniforms[ 'displacementScale' ].value = value;
          } );
  folderMaterialWireframe.add(params, 'opacityWireframe').min(0.0).max(1.0).step(0.01).onChange(
          function(value){
            wireframeMaterial.uniforms[ 'opacity' ].value = value;
          } );

  // gui.close();

  function setMeshSubdivision( mesh, value ) {

    var newGeometry = new PlaneBufferGeometryRnd( 512, 424,
            512/value, 424/value,
            params.vertexXYRandomness,
            params.vertexZRandomness
    );

    if ( mesh.type === "Group" ) {

      mesh.children.forEach( function( m ) {

        m.geometry.dispose();

        m.geometry = newGeometry.clone();

      } );

    }
    else {

      mesh.geometry = newGeometry;
    }

  }

  function setVertexRandomness( mesh ) {

    var newGeometry = new PlaneBufferGeometryRnd( 512, 424,
            512/params.subdivision, 424/params.subdivision,
            params.vertexXYRandomness,
            params.vertexZRandomness

    );

    if ( mesh.type === "Group" ) {

      mesh.children.forEach( function( m ) {

        m.geometry.dispose();

        m.geometry = newGeometry.clone();

      } );

    }
    else {

      mesh.geometry = newGeometry;
    }

  }

  function toggleRefraction( value ) {

    if ( value ) {
      textureSphere.mapping = THREE.EquirectangularRefractionMapping;
    }
    else {
      textureSphere.mapping = THREE.SphericalReflectionMapping;
    }

    textureSphere.needsUpdate = true;
    materialTest1.needsUpdate = true;

  }

  function toggleWireframe( value ) {

    object.children[ 0 ].visible = value;

  }

  function createThing() {

    var geometry = new PlaneBufferGeometryRnd( 512, 424, 512/params.subdivision, 424/params.subdivision );

    materialTest1.uniforms[ 'diffuse' ].value = params.color;
    materialTest1.uniforms[ 'displacementMap' ].value = video_texture;
    materialTest1.uniforms[ 'displacementScale' ].value = params.displacementScale;
    materialTest1.uniforms[ 'opacity' ].value = 1;
    materialTest1.uniforms[ 'envMap' ].value = textureSphere;
    materialTest1.uniforms[ 'roughness' ].value = params.roughness;
    materialTest1.uniforms[ 'metalness' ].value = params.metalness;
    materialTest1.uniforms[ 'refractionRatio' ].value = params.refractionRatio;

    materialTest1.uniforms[ 'resolution' ].value = new THREE.Vector2( depthWidth, depthHeight );
    materialTest1.uniforms[ 'lookupRadius' ].value = 4;


    //materialTest1.color = new THREE.Color( 0x2194ce );
    materialTest1.displacementMap = video_texture;
    materialTest1.shading = THREE.FlatShading;
    materialTest1.transparent = true;
    materialTest1.envMap = textureSphere;
    materialTest1.side = THREE.DoubleSide;

    //materialTest1.needsUpdate = true;

    wireframeMaterial = new THREE.ShaderMaterial( {

      uniforms: {

        "displacementMap" : { type: "t", value: video_texture },
        "displacementScale" : { type: "f", value: params.displacementScaleWireframe },
        "displacementBias" : { type: "f", value: 0 },
        "resolution" : { type: "v2", value: new THREE.Vector2( depthWidth, depthHeight ) },
        "lookupRadius" : { type: "f", value: params.lookupRadius },
        "mode" : { type: "f", value: 0.0 },
        "opacity" : { type: "f", value: params.opacityWireframe }

      },
      vertexShader: document.getElementById( 'vertexShader' ).textContent,
      fragmentShader: document.getElementById( 'fragmentShader_wireframe' ).textContent,

      wireframe: true,
      transparent: true,
      //depthWrite: false,
      //depthTest: false

    } );

    //var mesh = new THREE.Mesh( geometry, materialTest1 );

    var mesh = THREE.SceneUtils.createMultiMaterialObject( geometry, [ wireframeMaterial, materialTest1 ]);

    return mesh;

  }

  function addLights() {

    var ambientLight = new THREE.AmbientLight( 0x000000 );
    scene.add( ambientLight );

    lights[0] = new THREE.PointLight( 0xffffff, 0.5, 0 );
    lights[1] = new THREE.PointLight( 0xffffff, 0.5, 0 );
    lights[2] = new THREE.PointLight( 0xffffff, 0.5, 0 );
    //lights[3] = new THREE.DirectionalLight( 0xffffff, 2 );

    lights[0].position.set( -800, 60, 400 );
    lights[1].position.set( 0, 4, 400 );
    lights[2].position.set( 600, -30, 400 );
    //lights[3].position.set( -100, 0, -500 ).normalize();

    scene.add( lights[0] );
    scene.add( lights[1] );
    scene.add( lights[2] );
    //scene.add( lights[3] );

  }

  function init() {

    container = document.getElementById( 'container' );

    camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 10000 );
    camera.position.z = 360;

    scene = new THREE.Scene();

    addLights();

    var btns = document.getElementById('buttons').children;

    for (var i=0; i < btns.length; i++){

      video[i] = btns[i];
      video[i].playbackRate = 1.0;

      video[i].addEventListener("ended", function(args) {

        var ix = args.target.accessKey;
        //video[ix].currentTime = 0;
        //video[ix].play();
        video[ix].load();

      });

      video[i].addEventListener("click", function(args) {

        var other_btns = args.target.parentElement.children;
        var ix = args.target.accessKey;
        for (var i=0; i < other_btns.length; i++){
          if (i != ix) video[i].pause();
        }
        video[ix].paused ? video[ix].play() : video[ix].pause();

        //video_texture = new THREE.VideoTexture( video[ix] );
        //video_texture.minFilter = THREE.LinearFilter;
        //video_texture.magFilter = THREE.LinearFilter;
        //video_texture.format = THREE.RGBFormat;

      });

    }

    video_texture = new THREE.VideoTexture( video[0] );
    video_texture.minFilter = THREE.LinearFilter;
    video_texture.magFilter = THREE.LinearFilter;
    video_texture.format = THREE.RGBFormat;
    //video[1].play();

    textureSphere = THREE.ImageUtils.loadTexture( "../image/pai_pano_sm.jpg" );
    textureSphere.mapping = THREE.SphericalReflectionMapping;
    //textureSphere.mapping = THREE.EquirectangularRefractionMapping;

    var sphere = new THREE.Mesh( new THREE.SphereGeometry( 1000, 60, 60 ),
            new THREE.MeshBasicMaterial( { map: textureSphere } ) );
    sphere.scale.x = -1;
    sphere.doubleSided = true;
    //scene.add( sphere );


    object = createThing();

    scene.add( object );

    renderer = new THREE.WebGLRenderer({
      antialias: true
    });

    renderer.setClearColor( 0x000000 );
    renderer.setPixelRatio( window.devicePixelRatio );
    renderer.setSize( window.innerWidth, window.innerHeight );
    container.appendChild( renderer.domElement );

    controls = new THREE.OrbitControls( camera, renderer.domElement );
    controls.maxDistance = 1300;

    stats = new Stats();
    stats.domElement.style.position = 'absolute';
    stats.domElement.style.top = '0px';
    container.appendChild( stats.domElement );

    window.addEventListener( 'resize', onWindowResize, false );

  }

  function onWindowResize( event ) {

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, window.innerHeight );

  }

  function animate() {

    requestAnimationFrame( animate );

    render();
    stats.update();

  }

  var start = Date.now();

  function render() {

    var time = performance.now();

    //material.uniforms[ 'time' ].value = time;

    renderer.render( scene, camera );

  }

</script>

</body>
</html>
